name: Build and Package KMM Project

on:
  push:
    branches:
      - main
      - develop
      - master
  pull_request:
    branches:
      - main
      - develop

jobs:
  android-build:
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Build Android Debug APK
        run: ./gradlew assembleDebug --info

      - name: Run Android Unit Tests
        run: ./gradlew testDebugUnitTest

  ios-build:
    name: Build iOS
    runs-on: macos-latest
    needs: android-build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build iOS Framework
        run: ./gradlew linkDebugFrameworkIosSimulator

      - name: Run iOS Unit Tests
        run: ./gradlew iosX64Test

  dmg-build:
    name: Package DMG
    runs-on: macos-latest
    needs: ios-build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build DMG Package
        run: ./gradlew packageDMG
        # Ensure assembleDMG task creates a DMG file (e.g., build/distributions/MyApp.dmg)

      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bustlespot_macos_build
          path: build/distributions

  msi-build:
    name: Package MSI
    runs-on: windows-latest
    needs: android-build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build MSI Package
        run: .\gradlew packageMSI
        # Ensure assembleMSI task creates an MSI file (e.g., build/distributions/MyApp.msi)

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bustlespot_windows_build
          path: build/distributions

  deb-build:
    name: Package DEB
    runs-on: ubuntu-latest
    needs: android-build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build DEB Package
        run: ./gradlew packageDEB
        # Ensure assembleDEB task creates a DEB file (e.g., build/distributions/MyApp.deb)

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bustlespot_linux_build
          path: build/distributions

